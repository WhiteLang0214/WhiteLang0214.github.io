<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>全局API | note</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/lang.png">
    <meta name="description" content="langxue's blog">
    
    <link rel="preload" href="/assets/css/0.styles.443403f7.css" as="style"><link rel="preload" href="/assets/js/app.3affcc69.js" as="script"><link rel="preload" href="/assets/js/2.672bef9f.js" as="script"><link rel="preload" href="/assets/js/33.4b24bea9.js" as="script"><link rel="prefetch" href="/assets/js/10.3b4e95cf.js"><link rel="prefetch" href="/assets/js/11.3607e33a.js"><link rel="prefetch" href="/assets/js/12.9ae9b6ed.js"><link rel="prefetch" href="/assets/js/13.640441ab.js"><link rel="prefetch" href="/assets/js/14.e41d8f75.js"><link rel="prefetch" href="/assets/js/15.47483ee1.js"><link rel="prefetch" href="/assets/js/16.0f60e20e.js"><link rel="prefetch" href="/assets/js/17.7b6f93c3.js"><link rel="prefetch" href="/assets/js/18.d01d55fc.js"><link rel="prefetch" href="/assets/js/19.19e810ea.js"><link rel="prefetch" href="/assets/js/20.6381ff8a.js"><link rel="prefetch" href="/assets/js/21.f19afff0.js"><link rel="prefetch" href="/assets/js/22.5e2936a7.js"><link rel="prefetch" href="/assets/js/23.4bc59325.js"><link rel="prefetch" href="/assets/js/24.38718534.js"><link rel="prefetch" href="/assets/js/25.fb93bd24.js"><link rel="prefetch" href="/assets/js/26.ac3d43f8.js"><link rel="prefetch" href="/assets/js/27.a6fb9324.js"><link rel="prefetch" href="/assets/js/28.c86bef93.js"><link rel="prefetch" href="/assets/js/29.0273a5ee.js"><link rel="prefetch" href="/assets/js/3.3a393fef.js"><link rel="prefetch" href="/assets/js/30.f996e6c7.js"><link rel="prefetch" href="/assets/js/31.e46880bb.js"><link rel="prefetch" href="/assets/js/32.5da11746.js"><link rel="prefetch" href="/assets/js/34.8242ab4b.js"><link rel="prefetch" href="/assets/js/4.0c748dc5.js"><link rel="prefetch" href="/assets/js/5.1c4d6539.js"><link rel="prefetch" href="/assets/js/6.744a911e.js"><link rel="prefetch" href="/assets/js/7.9a79fc7f.js"><link rel="prefetch" href="/assets/js/8.8180d4af.js"><link rel="prefetch" href="/assets/js/9.e5fec9ba.js">
    <link rel="stylesheet" href="/assets/css/0.styles.443403f7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/lang.png" alt="note" class="logo"> <span class="site-name can-hide">note</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/js/" class="nav-link">
  js
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法题库
</a></div><div class="nav-item"><a href="https://baidu.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  微博
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/js/" class="nav-link">
  js
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法题库
</a></div><div class="nav-item"><a href="https://baidu.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  微博
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/vue3/" class="sidebar-heading clickable router-link-active open"><span>VUE3</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue3/optimize.html" class="sidebar-link">代码优化/核心特性</a></li><li><a href="/vue3/globalAPI.html" aria-current="page" class="active sidebar-link">全局API</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/react/" class="sidebar-heading clickable"><span>REACT</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/js/" class="sidebar-heading clickable"><span>JS</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/git/" class="sidebar-link">GIT</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/node/" class="sidebar-heading clickable"><span>Node</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/eslint/" class="sidebar-link">ESLINT</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/eslint/#no-param-reassign" class="sidebar-link">no-param-reassign</a></li><li class="sidebar-sub-header"><a href="/eslint/#do-not-use-new-for-side-effects-no-new" class="sidebar-link">Do not use 'new' for side effects (no-new)</a></li><li class="sidebar-sub-header"><a href="/eslint/#unary-operator-used-no-plusplus" class="sidebar-link">Unary operator '++' used no-plusplus</a></li></ul></li><li><a href="/optimize/" class="sidebar-link">性能优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/optimize/#_1-1-技术选型" class="sidebar-link">1.1 技术选型</a></li><li class="sidebar-sub-header"><a href="/optimize/#_1-2-network" class="sidebar-link">1.2 network</a></li><li class="sidebar-sub-header"><a href="/optimize/#_1-3-webpack-bundle-analyzer" class="sidebar-link">1.3 webpack-bundle-analyzer</a></li><li class="sidebar-sub-header"><a href="/optimize/#_1-4-performance" class="sidebar-link">1.4 performance</a></li><li class="sidebar-sub-header"><a href="/optimize/#_1-5-performancenavigtiontiming" class="sidebar-link">1.5 performanceNavigtionTiming</a></li><li class="sidebar-sub-header"><a href="/optimize/#_1-6-抓包" class="sidebar-link">1.6 抓包</a></li><li class="sidebar-sub-header"><a href="/optimize/#_1-7-性能测试工具" class="sidebar-link">1.7 性能测试工具</a></li><li class="sidebar-sub-header"><a href="/optimize/#_2-1-tree-shaking" class="sidebar-link">2.1 tree shaking</a></li><li class="sidebar-sub-header"><a href="/optimize/#_2-2-split-chunks-分包" class="sidebar-link">2.2 split chunks(分包)</a></li><li class="sidebar-sub-header"><a href="/optimize/#_2-3-拆包" class="sidebar-link">2.3 拆包</a></li><li class="sidebar-sub-header"><a href="/optimize/#_2-4-gzip" class="sidebar-link">2.4 gzip</a></li><li class="sidebar-sub-header"><a href="/optimize/#_2-5-图片压缩" class="sidebar-link">2.5 图片压缩</a></li><li class="sidebar-sub-header"><a href="/optimize/#_2-6-图片分割" class="sidebar-link">2.6 图片分割</a></li><li class="sidebar-sub-header"><a href="/optimize/#_2-7-sprite-雪碧图-精灵图" class="sidebar-link">2.7 sprite（雪碧图/精灵图）</a></li><li class="sidebar-sub-header"><a href="/optimize/#_2-8-cdn-内容分发网络" class="sidebar-link">2.8 CDN（内容分发网络）</a></li><li class="sidebar-sub-header"><a href="/optimize/#_2-9-懒加载" class="sidebar-link">2.9 懒加载</a></li><li class="sidebar-sub-header"><a href="/optimize/#_2-10-iconfont-字体图标" class="sidebar-link">2.10 iconfont(字体图标)</a></li><li class="sidebar-sub-header"><a href="/optimize/#_2-11-逻辑后移" class="sidebar-link">2.11 逻辑后移</a></li><li class="sidebar-sub-header"><a href="/optimize/#_2-12-算法复杂度" class="sidebar-link">2.12 算法复杂度</a></li><li class="sidebar-sub-header"><a href="/optimize/#_2-13-组件渲染" class="sidebar-link">2.13 组件渲染</a></li><li class="sidebar-sub-header"><a href="/optimize/#_2-14-node-middleware-node-中间件" class="sidebar-link">2.14 node middleware(node 中间件)</a></li><li class="sidebar-sub-header"><a href="/optimize/#_2-15-web-worker" class="sidebar-link">2.15 web worker</a></li><li class="sidebar-sub-header"><a href="/optimize/#_2-16-缓存" class="sidebar-link">2.16 缓存</a></li><li class="sidebar-sub-header"><a href="/optimize/#_2-17-gpu-渲染" class="sidebar-link">2.17 GPU 渲染</a></li><li class="sidebar-sub-header"><a href="/optimize/#_2-18-ajax-可缓存" class="sidebar-link">2.18 Ajax 可缓存</a></li><li class="sidebar-sub-header"><a href="/optimize/#_2-19-resource-hints" class="sidebar-link">2.19 Resource Hints</a></li><li class="sidebar-sub-header"><a href="/optimize/#_2-20-ssr" class="sidebar-link">2.20 SSR</a></li><li class="sidebar-sub-header"><a href="/optimize/#_2-21-unpkg" class="sidebar-link">2.21 UNPKG</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="全局api"><a href="#全局api" class="header-anchor">#</a> 全局API</h1> <ul><li><p>全局api是直接在 Vue 上挂载方法，在 Vue 中，全局API一共有13个，分别如下：</p> <ol><li>createapp 返回一个提供应用上下文的应用实例</li> <li>h 返回一个 “虚拟节点”</li> <li>definecomponent 返回 options 的对象，在 TS 下，会给予组件正确的参数类型推断；</li> <li>defineasynccomponent 创建一个只有在需要时才会加载的异步组件；</li> <li>resolvecomponent 按传入的组件名称解析 component；</li> <li>resolvedynamiccomponent 返回已解析的 Component 或 新建的 VNode;</li> <li>resolvedirective 通过其名称解析一个 directive</li> <li>withdirectives 返回一个包含应用指令的 VNode;</li> <li>createrenderer 跨平台自定义渲染；</li> <li>nexttick 是将回调函数延迟在下一次 dom 更新数据后调用；</li> <li>mergeprops 将包含 VNode prop 的多个对象合并为一个单独的对象；</li> <li>usecssmodule 访问 css 模块；</li> <li>version 查看已安装的 Vue 的版本号;</li></ol></li></ul> <p><b>01、createApp</b></p> <ul><li>官方定义：返回一个提供应用上下文的应用实例。应用实例挂载的整个组件树共享同一个上下文。</li> <li>理解：createApp 作为 vue 的启用函数，返回一个应用实例，每个 Vue 应用程序都首先使用以下函数创建一个新的应用实例，应用程序实例公开的大多数方法都返回相同的实例，可以链式调用。例如：</li></ul> <p><code>Vue.createapp({}).component('SearchInput', SearchInputComponent)</code></p> <ul><li><p>用法</p> <ul><li>第一个参数：接收一个根组件选项</li> <li>第二个参数：将根 prop 传递给应用程序</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 用法示例</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createApp<span class="token punctuation">,</span> h<span class="token punctuation">,</span> nextTick <span class="token punctuation">}</span> form <span class="token string">'vue'</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    methods<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    computed<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> username<span class="token operator">:</span> <span class="token string">'langxue'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><b>源码浅析</b></p> <p>GitHub 地址：</p> <ul><li>createapp() 56行-102行内容 [1]</li> <li>ensureRender() 35行 - 37行内容 [2]</li> <li>createRenderer() 419行 - 424行内容 [3]</li> <li>baseCreateRenderer() 448行 - 2418行内容[4]</li> <li>app._component 174行内容[5]</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> createApp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 使用 ensureRender().createApp() 来创建 app 对象</span>
    <span class="token comment">// 源码位置上方[2]</span>
    <span class="token comment">// -&gt; ensureRenderer 方法调用了来自 runtime-core 的 createRenderer</span>
    <span class="token comment">// 源码位置上方[3]</span>
    <span class="token comment">// -&gt; createRenderer(HostNode, HoseElement),两个通用参数 HostNode (主机环境中的节点)和 HostElement (宿主环境中的元素)，对应于宿主环境。</span>
    <span class="token comment">// -&gt; reateRenderer(使用(可选的)选项创建一个 Renderer 实例。)，该方法返回了 baseCreateRender</span>
    <span class="token comment">// 源码位置上方[4]</span>
    <span class="token comment">// -&gt; baseCreateRenderer 方法最终返回 render hydrate createApp 三个函数，生成的 render 传给 createAppAPI，hydrate 为可选参数，ssr 的场景下会用到。</span>

    <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">ensureRender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createApp</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// DEV 环境下，用于组件名称验证是否是原生标签或者svg属性标签</span>
        <span class="token function">injectNativeTagCheck</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
        <span class="token comment">// DEV 环境下，检查CompilerOptions如果有已弃用的属性，显示警告</span>
        <span class="token function">injectCompilerOptionsCheck</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> <span class="token punctuation">{</span> mount <span class="token punctuation">}</span> <span class="token operator">=</span> app
    <span class="token comment">// 从创建的 app 对象中结构获取 mount，改写 mount 方法后，返回 app 实例</span>
    app<span class="token punctuation">.</span>mount <span class="token operator">=</span> <span class="token punctuation">(</span>containerOrSelector<span class="token operator">:</span> Element <span class="token operator">|</span> ShandowRoot <span class="token operator">|</span> string<span class="token punctuation">)</span><span class="token operator">:</span><span class="token parameter">any</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// container 是真实的 DOM 元素，normalizeContainer 方法使用 document.querySelector 处理传入的 &lt;containerOrSelector&gt; 参数，如果在 DEV 环境下元素不存在或者元素为影子 DOM 并且 mode 状态为 closed，则返回相应的警告</span>
        <span class="token keyword">const</span> container <span class="token operator">=</span> <span class="token function">normalizeContainer</span><span class="token punctuation">(</span>containerOrSelector<span class="token punctuation">)</span>
        <span class="token comment">// 如果不是真实的 DOM 元素则 return</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>container<span class="token punctuation">)</span> <span class="token keyword">return</span>

        <span class="token comment">// 这里的app._component 其实就是全局 API 的 createApp 的第一个参数，源码位置在上方[5]</span>
        <span class="token keyword">const</span> component <span class="token operator">=</span> app<span class="token punctuation">.</span>_component
        <span class="token comment">// component 不是函数 并且 没有不包含 render、template</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isFunction</span><span class="token punctuation">(</span>component<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>component<span class="token punctuation">.</span>render <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>component<span class="token punctuation">.</span>template<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 不安全的情况</span>
            <span class="token comment">// 原因：可能在 dom 模版中执行 js 表达式。</span>
            <span class="token comment">// 用户必须确保内 dom 模版是可信的。如果它是模版，不应该包含任何用户数据</span>

            <span class="token comment">// 使用 DOM 的 innerhtml 作为 component.template 内容</span>
            component<span class="token punctuation">.</span>template <span class="token operator">=</span> container<span class="token punctuation">.</span>innerhtml
            <span class="token comment">// 2. 挂载前检查，获取元素属性的集合遍历如果 name 不是 v-cloak 状态 并且属性名称包含 v-、:、@、,会给出 vue 文档链接提示</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>__COMPAT__ <span class="token operator">&amp;&amp;</span> __DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>container<span class="token punctuation">.</span>attributes<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">const</span> attr <span class="token operator">=</span> container<span class="token punctuation">.</span>attributes<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>attr<span class="token punctuation">.</span>name <span class="token operator">!==</span> <span class="token string">'v-cloak'</span> <span class="token operator">&amp;&amp;</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^(v-|:|@)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>attr<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        compatUtils<span class="token punctuation">.</span><span class="token function">warnDeprecation</span><span class="token punctuation">(</span>DeprecationTypes<span class="token punctuation">.</span><span class="token constant">GLOBAL_MOUNT_CONTAINER</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                        <span class="token keyword">break</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 挂载前清除内容</span>
        container<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">''</span>
        <span class="token comment">// 真正的挂载（元素，是否为 SVG 元素）</span>
        <span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token function">mount</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> container <span class="token keyword">instanceof</span> <span class="token class-name">SVGElement</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>container <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 删除元素上的 v-cloak 指令</span>
            container<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span><span class="token string">'v-cloak'</span><span class="token punctuation">)</span>
            <span class="token comment">// 设置 data-v-app 属性</span>
            container<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'&gt;'</span>'<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> proxy
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> app
<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">as</span> CreateAppFuncion<span class="token operator">&lt;</span>Element<span class="token operator">&gt;</span>
</code></pre></div></li></ul> <p><b>02、h</b></p> <ul><li>官方定义：返回一个“虚拟节点”，通常缩写为 VNode: 一个普通对象，其中包含向 Vue 描述它应在页面上渲染哪种节点的信息，包括所有子节点的恶描述。它的目的是用于手动编写的渲染函数；</li></ul> <blockquote><p>h的含义如下：
It comes from the term &quot;hyperscript&quot;, which is commonly used in many virtual-dom implementations. &quot;Hyperscript&quot; itself stands for &quot;script that generates HTML structures&quot; because HTML is the acronym for &quot;hyper-text markup language&quot;.
它来自术语&quot;hyperscript&quot;，该术语常用于许多虚拟 dom 实现。&quot;Hyperscript&quot; 本身代表 &quot;生成 HTML 结构的脚本&quot;，因为 HTML 是&quot;超文本标记语言&quot;的首字母缩写词。
回复出处：github.com/vuewjs/babel......</p></blockquote> <ul><li><p>其实 h() 函数和 createVNode() 函数都是创建 dom 节点，他们的作用是一样的，但是在 VUE3 中，createVNode() 函数的功能比 h() 函数要多且做了性能优化，渲染节点的速度要更快。</p></li> <li><p>用法</p> <ul><li>第一个参数：HTML 标签名、组件、异步组件或函数式组件。使用返回 null 的函数将渲染一个注释。此参数是必需的。</li> <li>第二个参数：一个对象，与我们将在模板中使用的 attribute、prop、class 和、style 和事件相对应。可选</li> <li>第三个参数：子代 VNode，使用 h() 生成，或者使用字符串来获取“文本 VNode”,或带有插槽的对象。可选。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token string">'some text comes first.'</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'h1'</span><span class="token punctuation">,</span> <span class="token string">'A headline'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span>MyComponent<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        someProp<span class="token operator">:</span> <span class="token string">'foobar'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p><b>源码浅析</b></p> <p>GitHub 地址：</p> <ul><li>h 174行-196行内容 [6]</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 源码位置见上方[6]</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token operator">:</span> any<span class="token punctuation">,</span> propsOrChildren<span class="token operator">?</span><span class="token operator">:</span> any<span class="token punctuation">,</span> children<span class="token operator">?</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span><span class="token operator">:</span> VNode <span class="token punctuation">{</span>
    <span class="token keyword">const</span> l <span class="token operator">=</span> arguments<span class="token punctuation">.</span>length
    <span class="token comment">// 如果参数是两个</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>l <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 判断是否是对象，并且不为数组</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>propsOrChildren<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isArray</span><span class="token punctuation">(</span>propsOrChildren<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 所有 VNode 对象都有一个 __v_isVNode 属性，isVNode 方法也是根据这个属性来判断是会否为 VNode对象。</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isVNode</span><span class="token punctuation">(</span>propsOrChildren<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token function">createVNode</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>propsOrChildren<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 只包含属性不含有子元素</span>
            <span class="token keyword">return</span> <span class="token function">createVNode</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> propsOrChildren<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 忽略 props 属性</span>
            <span class="token keyword">return</span> <span class="token function">createVNode</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> propsOrChildren<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>l <span class="token operator">&gt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Array.protoytpe.slice.call(arguments, 2) 这句话的意思是把调用方法的参数截取出来，可以理解成是让 arguments 转换成一个数组对象，让 arguments 具有 slice() 方法</span>
            children <span class="token operator">=</span> Array<span class="token punctuation">.</span>proptotype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>l <span class="token operator">===</span> <span class="token number">3</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isVNode</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果参数长度等于3，并且第三个参数为 VNode 对象</span>
            children <span class="token operator">=</span> <span class="token punctuation">[</span>children<span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// h 函数内部的主要处理逻辑就是根据参数个数和参数类型，执行相应处理操作，但最终都是通过调用 createVNode 函数来创建 VNode 对象</span>
        <span class="token keyword">return</span> <span class="token function">createVNode</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> propsOrChildren<span class="token punctuation">,</span> children<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <p><b>03、defineComponent</b></p> <ul><li>官方定义：defineComponent 只返回传递给它的对象。但是，就类型而言，返回的值有一个合成类型的构造函数，用户手动渲染函数、TSX 和 IDE 工具支持。</li></ul> <blockquote><p>defineComponent 主要是用来帮助 Vue 在 TS 下正确推断出 setup() 组件的参数类型
引入 defineComponent() 以正确推断 setup() 组件的参数类型；
defineComponent 可以正确适配无 props、数组 props 等形式；</p></blockquote> <ul><li><p>用法
<strong>参数：</strong> 具有组件选项的对象或者是一个 setup 函数，函数名称将作为组件名称来使用</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 之前写 Ts+Vue ，需要生命相关的数据类型。如下</span>
<span class="token comment">// 声明 props 和 return 的数据类型</span>
<span class="token keyword">interface</span> <span class="token class-name">Data</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span>key<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> unknown
<span class="token punctuation">}</span>
<span class="token comment">// 使用的时候入参要加上声明，return 也要加上声明</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    <span class="token function">setup</span><span class="token punctuation">(</span>props<span class="token operator">:</span> Data<span class="token punctuation">)</span><span class="token operator">:</span> Data <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 非常繁琐，使用 defineComponent 之后，就可以省略这些类型定义，defineComponent 可以接受显式的自定义 props 接口或从属性验证对象中自动推断；</span>

<span class="token comment">// 用法示例1</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">const</span> MyComponnet <span class="token operator">=</span> <span class="token function">defineComponnet</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> count<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    methods<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token operator">++</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 用法示例2:</span>
<span class="token comment">// 不只适用于 setup，只要是 Vue 本身的 API，defineComponent 都可以自动帮你推导</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent <span class="token punctuation">}</span> form <span class="token string">'vue'</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function">setup</span><span class="token punctuation">(</span><span class="token parameter">props<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><b>源码浅析</b></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 实际上这个 api 只是直接 return 传进来的 options, export default defineComponent({}) 是有点等价于 export default{}, 目前看来这样做的最大作用只是限制 type，setup 必须是函数，props 必须是 undefined 或者 对象。</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token parameter">options<span class="token operator">:</span> unknown</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">isFunction</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">{</span> setup<span class="token operator">:</span> options<span class="token punctuation">,</span> name<span class="token operator">:</span> options<span class="token punctuation">.</span>name <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <p><b>04、defineAsyncComponent</b></p> <ul><li><p>官方定义：创建一个只有在需要时才会加载的一步组件。</p></li> <li><p>用法</p> <ul><li>参数：接受一个返回 Promise 的工厂函数。Promise 的 resolve 回调应该在服务端返回组件定义后被调用。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 在 Vue2.x 中，声明一个异步组件只需这样</span>
<span class="token keyword">const</span> <span class="token function-variable function">asyncModal</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./Modal.vue'</span><span class="token punctuation">)</span>
<span class="token comment">// 或者</span>
<span class="token keyword">const</span> asyncModal <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">component</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./Modal.vue'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    delay<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
    timeout<span class="token operator">:</span> <span class="token number">3000</span><span class="token punctuation">,</span>
    error<span class="token operator">:</span> ErrorComponent<span class="token punctuation">,</span>
    loading<span class="token operator">:</span> LoadingComponent
<span class="token punctuation">}</span>


<span class="token comment">// 在 vue3 中，由于函数是组件被定义为纯函数，因此异步组件的定义需要通过将其包裹在新的 defineAsyncComponent 助手方法中来显式地定义：</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineAsyncComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> ErrorComponent <span class="token keyword">from</span> <span class="token string">'./components/ErrorComponent.vue'</span>
<span class="token keyword">import</span> LoadingComponent <span class="token keyword">from</span> <span class="token string">'./componnets/loadingComponent.vue'</span>

<span class="token comment">// 不带选项的一步组件</span>
<span class="token keyword">const</span> asyncModalWithOpgions <span class="token operator">=</span> <span class="token function">defineAsyncComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function-variable function">loader</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./Modal.vue'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    delay<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
    timeout<span class="token operator">:</span> <span class="token number">3000</span><span class="token punctuation">,</span>
    errorComponent<span class="token operator">:</span> ErrorComponent<span class="token punctuation">,</span>
    loadingComponnet<span class="token operator">:</span> LoadingComponent
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><b>源码浅析</b>
GitHub地址：41行 - 196行</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 源码位置见上方</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> defineAsyncComponent<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token keyword">new</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> ComponentPublicInstance <span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>source<span class="token operator">:</span> AsyncComponentLoader<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token operator">|</span> AsyncComponentOptions<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token constant">T</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFunction</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        source <span class="token operator">=</span> <span class="token punctuation">{</span> loader<span class="token operator">:</span> source <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 异步组件的参数</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>
        loader<span class="token punctuation">,</span>
        loadingComponent<span class="token punctuation">,</span>
        errorComponent<span class="token punctuation">,</span>
        delay <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">,</span>
        timeout<span class="token punctuation">,</span> <span class="token comment">// undefined = never times out</span>
        suspensible <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        onError<span class="token operator">:</span> userOnError
    <span class="token punctuation">}</span> <span class="token operator">=</span> source

    <span class="token keyword">let</span> pendingRequest<span class="token operator">:</span> Promise<span class="token operator">&lt;</span>ConcreteComponent<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">let</span> resolvedComp<span class="token operator">:</span> ConcreteComponent <span class="token operator">|</span> <span class="token keyword">undefined</span>

    <span class="token keyword">let</span> retries <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token comment">// 重新尝试load的到组件内容</span>
    <span class="token keyword">const</span> <span class="token function-variable function">retry</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        retries<span class="token operator">++</span>
        pendingRequest <span class="token operator">=</span> <span class="token keyword">null</span>
        <span class="token keyword">return</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> load <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>ConcreteComponent<span class="token operator">&gt;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> thisRequest<span class="token operator">:</span> Promise<span class="token operator">&lt;</span>ConcreteComponent<span class="token operator">&gt;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>
            <span class="token comment">// 如果 pendingRequest 存在就 return，否则实行 loader()</span>
            pendingRequest <span class="token operator">||</span> <span class="token punctuation">(</span>thisRequest <span class="token operator">=</span> pengdingRequest <span class="token operator">=</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">// 失败场景处理</span>
            <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                err <span class="token operator">=</span> err <span class="token keyword">instanceof</span> <span class="token class-name">Error</span> <span class="token operator">?</span> err <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token function">String</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>userOnError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 对应文档中的失败捕获回调函数 用户使用</span>
                    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token keyword">const</span> <span class="token function-variable function">userRetry</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">retry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token keyword">const</span> <span class="token function-variable function">userFail</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
                        <span class="token function">userOnError</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> userRetry<span class="token punctuation">,</span> userFail<span class="token punctuation">,</span> retries <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> err
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">comp<span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>thisRequest <span class="token operator">!==</span> pendingRequest <span class="token operator">&amp;&amp;</span> pendingRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> pendingRequest
                <span class="token punctuation">}</span>
                <span class="token comment">// 如果在 DEV 环境则警告</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>comp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Async component loader resolved to undefined.</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">If you are using retry(),make sure to return its return value.</span><span class="token template-punctuation string">`</span></span>
                    <span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// interop module default</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>comp <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>comp<span class="token punctuation">.</span>__esModule <span class="token operator">||</span> comp<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>toStringTag<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'Module'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    comp <span class="token operator">=</span> comp<span class="token punctuation">.</span>default
                <span class="token punctuation">}</span>
                <span class="token comment">// 如果在 DEV 环境则警告</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> comp <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>comp<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isFunction</span><span class="token punctuation">(</span>comp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Invalid async component load result: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>comp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                resolvedComp <span class="token operator">=</span> comp
                <span class="token keyword">return</span> comp
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        __asynvLoader<span class="token operator">:</span> load<span class="token punctuation">,</span>
        <span class="token comment">// 异步组件统一名字</span>
        name<span class="token operator">:</span> <span class="token string">'AsyncComponentWrapper'</span><span class="token punctuation">,</span>
        <span class="token comment">// 组件有 setup 方法的走 setup 逻辑</span>
        <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> instance <span class="token operator">=</span> currentInstance<span class="token operator">!</span>

            <span class="token comment">// already resolved</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>resolvedComp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">createInnerComp</span><span class="token punctuation">(</span>resolvedComp<span class="token operator">!</span><span class="token punctuation">,</span> instance<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            
            <span class="token keyword">const</span> <span class="token function-variable function">onError</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token operator">:</span> Error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                pendingRequest <span class="token operator">=</span> <span class="token keyword">null</span>
                <span class="token function">handleError</span><span class="token punctuation">(</span>
                    err<span class="token punctuation">,</span>
                    instance<span class="token punctuation">,</span>
                    ErrorCodes<span class="token punctuation">.</span><span class="token constant">ASYNC_COMPONENT_LOADER</span><span class="token punctuation">,</span>
                    <span class="token operator">!</span>errorComponnet <span class="token comment">/* do not throw in dev if user provided error component */</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// suspense-controlled or SSR</span>
            <span class="token comment">// 对应文档中如果父组件是一个 suspense 那么只返回 promise 结果 其余的控制交给 suspense 处理即可</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>
                <span class="token punctuation">(</span>__FEATURE_SUSPENSE__ <span class="token operator">&amp;&amp;</span> suspensible <span class="token operator">&amp;&amp;</span> instance<span class="token punctuation">.</span>suspense<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>__NODE_JS__ <span class="token operator">&amp;&amp;</span> isInSSRComponentSetup<span class="token punctuation">)</span>
            <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">comp</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">createInnerComp</span><span class="token punctuation">(</span>comp<span class="token punctuation">,</span> instance<span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token function">onError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
                    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> errorComponent <span class="token operator">?</span> <span class="token function">createVNode</span><span class="token punctuation">(</span>errorComponent <span class="token keyword">as</span> ConcreteComponnet<span class="token punctuation">,</span> <span class="token punctuation">{</span> error<span class="token operator">:</span> err <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            
            <span class="token keyword">const</span> loaded <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
            <span class="token keyword">const</span> error <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">const</span> delayed <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>delay<span class="token punctuation">)</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>delay<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    delayed<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span> delay<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>loaded<span class="token punctuation">.</span>value <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>error<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">const</span> err <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Async component timed out after </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>timeout<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
                        <span class="token function">onError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
                        error<span class="token punctuation">.</span>value <span class="token operator">=</span> err
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span> timeout<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">// promise 成功返回后出发 trigger 导致组件更新 重新渲染组件 只不过此时我们已经得到组件内容</span>
                loaded<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">true</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token function">onError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
                error<span class="token punctuation">.</span>value <span class="token operator">=</span> err
            <span class="token punctuation">}</span><span class="token punctuation">)</span>

            <span class="token comment">// 返回的函数会被当作组件实例的 render 函数</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">// render 初始之行出发 loaded 的依赖收集</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>loaded<span class="token punctuation">.</span>value <span class="token operator">&amp;&amp;</span> resolvedComp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token function">createInnerComp</span><span class="token punctuation">(</span>resolvedComp<span class="token punctuation">,</span> instance<span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>value <span class="token operator">&amp;&amp;</span> errorComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token function">createVNode</span><span class="token punctuation">(</span>errorComponent <span class="token keyword">as</span> ConcreteComponent<span class="token punctuation">,</span> <span class="token punctuation">{</span> error<span class="token operator">:</span> error<span class="token punctuation">.</span>value <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>loadingComponent <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>delayed<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token function">createVNode</span><span class="token punctuation">(</span>loadingComponent <span class="token keyword">as</span> ConcreteComponent<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">as</span> any
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <p><b>05、resolveComponent</b></p> <ul><li><p>官方定义：如果在当前应用实例中可用，则允许按名称解析 component，返回一个 Component。如果没有找到，则返回接收的参数 name。</p></li> <li><p>用法</p> <ul><li>参数：已加载的组件的名称</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'MyComponent'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token comment">/* ... */</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> resolveComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> MyComponent <span class="token operator">=</span> <span class="token function">resolveComponent</span><span class="token punctuation">(</span><span class="token string">'MyComponent'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><b>源码浅析</b></p> <p>GitHub地址：</p> <ul><li>resolveComponent(): 21行 - 27行[7]</li> <li>resolveAsset(): 62行 - 123行[8]</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 接收一个 name 参数，主要还是在 resolveAsset 方法中做了处理，源码位置见上方[7]</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">resolveComponent</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token operator">:</span> string<span class="token punctuation">,</span> maybeSelfReference<span class="token operator">?</span><span class="token operator">:</span> boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> ConcreteComponent <span class="token operator">|</span> string <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">resolveAsset</span><span class="token punctuation">(</span><span class="token constant">COMPONENTS</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> maybeSelfReference<span class="token punctuation">)</span> <span class="token operator">||</span> name
<span class="token punctuation">}</span>

<span class="token comment">// resolveAsset 源码见上方地[8]</span>
<span class="token keyword">function</span> <span class="token function">resolveAsset</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token operator">:</span> AssetTypes<span class="token punctuation">,</span> name<span class="token operator">:</span> string<span class="token punctuation">,</span> warnMissing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> maybeSelfReference <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 寻找当前渲染实力，不存在则为当前实例</span>
    <span class="token keyword">const</span> instance <span class="token operator">=</span> currentRenderingInstance <span class="token operator">||</span> currentInstance
    <span class="token keyword">if</span> <span class="token punctuation">(</span>instance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> Component <span class="token operator">=</span> instance<span class="token punctuation">.</span>type

        <span class="token comment">// 自我名称具有高级的优先级</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token constant">COMPONENTS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// getComponentName 首先判断传入的 Component 参数是不是函数，如果是函数优先使用 .displayName 属性，其次使用 .name</span>
            <span class="token keyword">const</span> selfName <span class="token operator">=</span> <span class="token function">getComponentName</span><span class="token punctuation">(</span>Component<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>
                <span class="token comment">// camelize 使用 replace 方法，正则/-(\w)/gname,匹配后 toUpperCase() 转换成大写</span>
                <span class="token comment">// capotalize 函数：str.charAt(0).toUppercase() + str.slice(1) 首字母大写 + 处理后的字符</span>
                selfName <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> selfName <span class="token operator">===</span> name <span class="token operator">||</span> selfName <span class="token operator">===</span> <span class="token function">camelize</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">||</span> selfName <span class="token operator">===</span> <span class="token function">capitalize</span><span class="token punctuation">(</span><span class="token function">camelize</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> Component
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">const</span> res <span class="token operator">=</span> 
        <span class="token comment">// 注册</span>
        <span class="token comment">// 首先检查实例[type]，它被解析为选项 API</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>instance<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">(</span>Component <span class="token keyword">as</span> ComponentOptions<span class="token punctuation">)</span><span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token operator">||</span> 
        <span class="token comment">// 全局注册</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span>appContext<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res <span class="token operator">&amp;&amp;</span> maybeSelfReference<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> Component
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> warnMissing <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Failed to resolve </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>type<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">return</span> res
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果实例不存在，并且在 DEV 环境警告：can only be used in render() or setup()</span>
        <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">resolve</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">capitalize</span><span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">can only be used in render() or setup().</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <p><b>06、resolveDynamicComponent</b></p> <ul><li><p>官方定义：返回已解析的 Component 或新创建的 VNode,其中组件名称作为节点标签。如果找不到 Component，将发出警告。</p></li> <li><p>用法</p> <ul><li>参数：接受一个参数：component</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> resolveDynamicComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> MyComponent <span class="token operator">=</span> <span class="token function">resolveDynamicComponent</span><span class="token punctuation">(</span><span class="token string">'MyComponent'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><b>源码浅析</b>
GitHub地址：</p> <ul><li>resolveDirective(): 43行 - 48行内容 [9]</li> <li>resolveAsset(): 62行 - 123行</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 源码位置位于上方[9]位置处</span>
<span class="token comment">// 根据该函数的名称，我们可以知道它用于解析动态组件,在 resolveDynamicComponent 函数内部，若 component 参数是字符串类型，则会调用前面介绍的 resolveAsset 方法来解析组件,</span>
<span class="token comment">// 如果 resolveAsset 函数获取不到对应的组件，则会返回当前 component 参数的值。比如 resolveDynamicComponent('div') 将返回 'div' 字符串</span>
<span class="token comment">// 源码见上方[1]地址</span>
<span class="token keyword">export</span> funtion <span class="token function">resolveDynamicComponent</span><span class="token punctuation">(</span>coomponent<span class="token operator">:</span> unknown<span class="token punctuation">)</span><span class="token operator">:</span> VNodeType <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>component<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">resolveAsset</span><span class="token punctuation">(</span><span class="token constant">COMPONENTS</span><span class="token punctuation">,</span> component<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">||</span> component
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 无效类型将引发警告，如果 component 参数非字符串类型，则会返回 component || NULL_DYNAMIC_COMPONENT 这行语句的执行结果，其中 NULL_DYNAMIC_COMPONENT 的值是一个 Symbol 对象</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>component <span class="token operator">||</span> <span class="token constant">NULL_DYNAMIC_COMPONENT</span><span class="token punctuation">)</span> <span class="token keyword">as</span> any
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// resolveAssets 函数解析见上方 [8] 位置处</span>
</code></pre></div></li></ul> <p><b>07、resolveDirective</b></p> <p>如果在当前应用实例中可用，则允许通过其名称解析一个directive。返回一个Directive。如果没有找到，则返回undefined。</p> <ul><li><p>用法</p> <ul><li>第一个参数：已加载的指令的名称。</li></ul> <p><b>源码浅析</b></p> <p>GitHub地址：</p> <ul><li>resolvedirective(): 43行 - 48行内容 [10]</li> <li>resolveAsset(): 62行 - 123行</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 源码位置见上方[10]位置处
*/</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">resolveDirective</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token operator">:</span> string</span><span class="token punctuation">)</span><span class="token operator">:</span> Directive <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token punctuation">{</span>
    <span class="token comment">// 然后调用前面介绍的 resolveAsset 方法来解析组件,resolveAsset函数解析见上方[8]位置处</span>
    <span class="token keyword">return</span> <span class="token function">resolveAssets</span><span class="token punctuation">(</span><span class="token constant">DIRECTIVES</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <p><b>08、withDirectives</b></p> <ul><li><p>官方定义：允许将指令应用于 VNode。返回一个包含应用指令的 VNode。</p></li> <li><p>用法</p> <ul><li>第一个参数：一个虚拟节点，通常使用 h() 创建</li> <li>第二个参数：一个指令数组，每个指令本身都是一个数组，最多可以定义 4 个索引。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> withDirectives<span class="token punctuation">,</span> resolveDirective <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token function">resolveDirective</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> bar <span class="token operator">=</span> <span class="token function">resolveDirective</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">)</span>

<span class="token keyword">return</span> <span class="token function">withDirectives</span><span class="token punctuation">(</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token punctuation">[</span>foo<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>x<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>bar<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>y<span class="token punctuation">]</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p><b>源码浅析</b>
GitHub地址：</p> <ul><li>resolveDirective(): 85行 - 114行内容 [1]</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> withDirectives<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">VNode</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
    vnode<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">,</span>
    directives<span class="token operator">:</span> DirectiveArguments
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> internalInstance <span class="token operator">=</span> currentRenderingInstance
    <span class="token keyword">if</span> <span class="token punctuation">(</span>internalInstance <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        __DEV__ <span class="token operator">&amp;&amp;</span> <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">withDirectives can only be used inside render functons.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> vnode
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> instance <span class="token operator">=</span> internalInstance<span class="token punctuation">.</span>proxy
    <span class="token keyword">const</span> bindings<span class="token operator">:</span> DirectiveBinding<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> vnode<span class="token punctuation">.</span>dirs <span class="token operator">||</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>dirs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>directives<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token punctuation">[</span>dir<span class="token punctuation">,</span> value<span class="token punctuation">,</span> arg<span class="token punctuation">,</span> modifiers <span class="token operator">=</span> <span class="token constant">EMPTY_OBJ</span><span class="token punctuation">]</span> <span class="token operator">=</span> directives<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFunction</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            dir <span class="token operator">=</span> <span class="token punctuation">{</span>
                mounted<span class="token operator">:</span> dir<span class="token punctuation">,</span>
                updated<span class="token operator">:</span> dir<span class="token punctuation">,</span>
            <span class="token punctuation">}</span> <span class="token keyword">as</span> ObjectDirective
        <span class="token punctuation">}</span>
        bindings<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            dir<span class="token punctuation">,</span>
            instance<span class="token punctuation">,</span>
            value<span class="token punctuation">,</span>
            oldValue<span class="token operator">:</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">,</span>
            arg<span class="token punctuation">,</span>
            modifiers
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> vnode
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <p><b>09、createRenderer</b></p> <ul><li><p>官方定义：createRenderer 函数接受两个范型参数：HostNode 和 HostElement，对应于宿主环境中的 Node 和 Element 类型。</p></li> <li><p>用法</p> <ul><li>第一个参数：HostNode 宿主环境中的节点</li> <li>第二个参数：Element 宿主环境中的元素</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 对于 runtime-dom，HostNode 将是 DOM Node 接口，HostElement 将是 DOM Element 接口。</span>
<span class="token comment">// 自定义渲染器可以传入特定于平台的类型，如下所示：</span>

<span class="token comment">// createRenderer(HostNode, HostElement),两个通用参数HostNode(主机环境中的节点)和HostElement(宿主环境中的元素)，对应于宿主环境。</span>
<span class="token comment">// reateRenderer(使用（可选的）选项创建一个 Renderer 实例。),该方法返回了 baseCreateRenderer</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> createRenderer<span class="token operator">&lt;</span>HostNode <span class="token operator">=</span> RendererNode<span class="token punctuation">,</span> HostElement <span class="token operator">=</span> RendererElement<span class="token operator">&gt;</span><span class="token punctuation">(</span>options<span class="token operator">:</span> RendererOptions<span class="token operator">&lt;</span>HostNode<span class="token punctuation">,</span> HostElement<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> baseCreateRenderer<span class="token operator">&lt;</span>HostNode<span class="token punctuation">,</span> HostElement<span class="token operator">&gt;</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><b>源码解析</b></p> <ul><li>createRenderer（）：419 行- 424行内容 [3]</li> <li>baseCreateRenderer()：448 行- 2418行 [4]</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> createRenderer<span class="token operator">&lt;</span>
HostNode <span class="token operator">=</span> RendererNode<span class="token punctuation">,</span>
HostElement <span class="token operator">=</span> RendererElement
<span class="token operator">&gt;</span><span class="token punctuation">(</span>options<span class="token operator">:</span> RendererOptions<span class="token operator">&lt;</span>HostNode<span class="token punctuation">,</span> HostElement<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">return</span> baseCreateRenderer<span class="token operator">&lt;</span>HostNode<span class="token punctuation">,</span> HostElement<span class="token operator">&gt;</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// baseCreateRenderer这个放2000行的左右的代码量，这里就完整不贴过来了，里面是渲染的核心代码，从平台特性 options 取出相关 API，实现了 patch、处理节点、处理组件、更新组件、安装组件实例等等方法，最终返回了一个renderer对象。</span>
<span class="token keyword">function</span> <span class="token function">baseCreateRenderer</span><span class="token punctuation">(</span>
<span class="token parameter">options<span class="token operator">:</span> RendererOptions<span class="token punctuation">,</span>
createHydrationFns<span class="token operator">?</span><span class="token operator">:</span> <span class="token keyword">typeof</span> createHydrationFunctions</span>
<span class="token punctuation">)</span><span class="token operator">:</span> any <span class="token punctuation">{</span>
<span class="token comment">// compile-time feature flags check</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>__ESM_BUNDLER__ <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>__TEST__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">initFeatureFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">||</span> __FEATURE_PROD_DEVTOOLS__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token function">getGlobalThis</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    target<span class="token punctuation">.</span>__VUE__ <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token function">setDevtoolsHook</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>__VUE_DEVTOOLS_GLOBAL_HOOK__<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>
    insert<span class="token operator">:</span> hostInsert<span class="token punctuation">,</span>
    remove<span class="token operator">:</span> hostRemove<span class="token punctuation">,</span>
    patchProp<span class="token operator">:</span> hostPatchProp<span class="token punctuation">,</span>
    forcePatchProp<span class="token operator">:</span> hostForcePatchProp<span class="token punctuation">,</span>
    createElement<span class="token operator">:</span> hostCreateElement<span class="token punctuation">,</span>
    createText<span class="token operator">:</span> hostCreateText<span class="token punctuation">,</span>
    createComment<span class="token operator">:</span> hostCreateComment<span class="token punctuation">,</span>
    setText<span class="token operator">:</span> hostSetText<span class="token punctuation">,</span>
    setElementText<span class="token operator">:</span> hostSetElementText<span class="token punctuation">,</span>
    parentNode<span class="token operator">:</span> hostParentNode<span class="token punctuation">,</span>
    nextSibling<span class="token operator">:</span> hostNextSibling<span class="token punctuation">,</span>
    setScopeId<span class="token operator">:</span> hostSetScopeId <span class="token operator">=</span> <span class="token constant">NOOP</span><span class="token punctuation">,</span>
    cloneNode<span class="token operator">:</span> hostCloneNode<span class="token punctuation">,</span>
    insertStaticContent<span class="token operator">:</span> hostInsertStaticContent
<span class="token punctuation">}</span> <span class="token operator">=</span> options
<span class="token operator">...</span>
<span class="token operator">...</span>
    <span class="token operator">...</span>
<span class="token comment">// 返回 render hydrate createApp三个函数，生成的 render 传给 createAppAPI ，hydrate 为可选参数，ssr 的场景下会用到；</span>
<span class="token keyword">return</span> <span class="token punctuation">{</span>
    render<span class="token punctuation">,</span>
    hydrate<span class="token punctuation">,</span>
    createApp<span class="token operator">:</span> <span class="token function">createAppAPI</span><span class="token punctuation">(</span>render<span class="token punctuation">,</span> hydrate<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <p><b>10、nextTick</b></p> <ul><li>官方定义：将回调推迟到下一个 DOM 更新周期之后执行。在更改了一些数据以等待 DOM 更新后立即使用它</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createApp<span class="token punctuation">,</span> nextTick <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token string">'Hello!'</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> changeMessage <span class="token operator">=</span> asynv <span class="token parameter">newMessage</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            message<span class="token punctuation">.</span>value <span class="token operator">=</span> newMessage
            <span class="token keyword">await</span> <span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Now DOM is updated'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><b>源码浅析</b></p> <p>GitHub地址：</p> <ul><li>nextTick()：42行 - 48行内容</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 源码位置在上方</span>

<span class="token comment">// 这里直接创建一个异步任务，但是改变dom属性也是异步策略，怎么保证dom加载完成</span>
<span class="token comment">// Vue2.x是 会判断浏览器是否支持promise属性 -&gt; 是否支持MutationObserver -&gt; 是否支持setImmediate  -&gt; 都不支持使用setTimeout，Vue3不再支持IE11，所以nextTick直接使用Promise</span>

<span class="token comment">// Vue 异步执行 DOM 更新。只要观察到数据变化，Vue 将开启一个队列，并缓冲在同一事件循环中发生的所有数据改变。如果同一个 watcher 被多次触发，只会被推入到队列中一次。这种在缓冲时去除重复数据对于避免不必要的计算和 DOM 操作上非常重要。然后，在下一个的事件循环“tick”中，Vue 刷新队列并执行实际 (已去重的) 工作。</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">nextTick</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token keyword">this</span><span class="token operator">:</span> ComponentPublicInstance <span class="token operator">|</span> <span class="token keyword">void</span><span class="token punctuation">,</span>
  fn<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> p <span class="token operator">=</span> currentFlushPromise <span class="token operator">||</span> resolvedPromise
  <span class="token keyword">return</span> fn <span class="token operator">?</span> p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">?</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">:</span> fn<span class="token punctuation">)</span> <span class="token operator">:</span> p
<span class="token punctuation">}</span>

<span class="token comment">// 你设置vm.someData = 'new value'，该组件不会立即重新渲染。当刷新队列时，组件会在事件循环队列清空时的下一个“tick”更新。如果你想在 DOM 状态更新后做点什 ，可以在数据变化之后立即使用Vue.nextTick(callback) 。</span>

</code></pre></div><p><b>11、mergeProps</b></p> <ul><li><p>官方定义：将包含 VNode prop 的多个对象合并为一个单独的对象。其返回的是一个新创建的对象，而作为参数传递的对象则不会被修改。</p></li> <li><p>用法</p> <ul><li>参数：可以传递不限数量的对象</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> h<span class="token punctuation">,</span> mergeProps <span class="token punctuation">}</span> form <span class="token string">'vue'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    inheritAttrs<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token function">mergeProps</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token comment">// 该 class 将与 $attrs 中的其他 class 合并。</span>
        <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'active'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$attrs<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> props<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><b>源码浅析</b></p> <p>GitHub地址：</p> <ul><li>mergeProps()：687行 - 712行</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">mergeProps</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args<span class="token operator">:</span> <span class="token punctuation">(</span>Data <span class="token operator">&amp;</span> VNodeProps<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// extend就是Object.assign方法， ret合并第一个参数为对象</span>
    <span class="token keyword">const</span> ret <span class="token operator">=</span> <span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment">// 遍历args参数</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> args<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> toMerge <span class="token operator">=</span> args<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> toMerge<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">'class'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 合并class</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">.</span>class <span class="token operator">!==</span> toMerge<span class="token punctuation">.</span>class<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ret<span class="token punctuation">.</span>class <span class="token operator">=</span> <span class="token function">normalizeClass</span><span class="token punctuation">(</span><span class="token punctuation">[</span>ret<span class="token punctuation">.</span>class<span class="token punctuation">,</span> toMerge<span class="token punctuation">.</span>class<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">'style'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 合并style</span>
            ret<span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token function">normalizeStyle</span><span class="token punctuation">(</span><span class="token punctuation">[</span>ret<span class="token punctuation">.</span>style<span class="token punctuation">,</span> toMerge<span class="token punctuation">.</span>style<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isOn</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>、
            <span class="token comment">// 判断是不是以 on开头的</span>
            <span class="token keyword">const</span> existing <span class="token operator">=</span> ret<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
            <span class="token keyword">const</span> incoming <span class="token operator">=</span> toMerge<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>existing <span class="token operator">!==</span> incoming<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果第一个参数中不存在,则合并，否则新增</span>
            ret<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> existing
                <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>existing <span class="token keyword">as</span> any<span class="token punctuation">,</span> incoming <span class="token keyword">as</span> any<span class="token punctuation">)</span>
                <span class="token operator">:</span> incoming
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// key不为空则添加属性</span>
            ret<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> toMerge<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ret
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <p><b>12、useCssModule</b></p> <ul><li><p>官方定义：允许在 setup 的单文件组件函数中访问 CSS 模块。</p></li> <li><p>用法</p> <ul><li>参数：CSS 模块的名称。默认为 '$style'</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// useCssModule 只能在 render 或 setup 函数中使用。</span>
<span class="token comment">// 这里的name不止可以填写$style,</span>
<span class="token comment">/*
*&lt;style module=&quot;aaa&quot;
* ...
*&lt;/style&gt;
*/</span>
<span class="token comment">// 这样就可以使用 const style = useCssModule(‘aaa'),来获取相应内容</span>

<span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
    <span class="token keyword">import</span> <span class="token punctuation">{</span> h<span class="token punctuation">,</span> useCssModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
    <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
        <span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> style <span class="token operator">=</span> <span class="token function">useCssModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            <span class="token keyword">class</span><span class="token operator">:</span> style<span class="token punctuation">.</span>success
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'Task complete!'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">&lt;style module&gt;
    .success</span> <span class="token punctuation">{</span>
        <span class="token property">color</span><span class="token punctuation">:</span> #090<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
&lt;/style&gt;

// 在 &lt;style&gt; 上添加 module 后， $style的计算属性就会被自动注入组件。
&lt;style module&gt;
    .six
        <span class="token property">color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    .one
        <span class="token property">font-size</span><span class="token punctuation">:</span>62px<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
&lt;/style&gt;
</code></pre></div><div class="language-html extra-class"><pre class="language-html"><code>// 添加model后可以直接使用$style绑定属性
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>$style.red<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            hello red!
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li></ul> <p><b>源码解析</b></p> <p>GitHub地址：</p> <ul><li>useCssModule()：1行 - 30行</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> warn<span class="token punctuation">,</span> getCurrentInstance <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vue/runtime-core'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">EMPTY_OBJ</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vue/shared'</span>

<span class="token comment">// 取出 this.$style </span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useCssModule</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">'$style'</span><span class="token punctuation">)</span><span class="token operator">:</span> Record<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> string<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">/* 如果是istanbul覆盖率测试则跳出 */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>__GLOBAL__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取当前实例</span>
    <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token function">getCurrentInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>instance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// useCssModule 只能在 render 或 setup 函数中使用。</span>
      __DEV__ <span class="token operator">&amp;&amp;</span> <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">useCssModule must be called inside setup()</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token comment">// EMPTY_OBJ是使用Object.freeze()冻结对象</span>
      <span class="token keyword">return</span> <span class="token constant">EMPTY_OBJ</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> modules <span class="token operator">=</span> instance<span class="token punctuation">.</span>type<span class="token punctuation">.</span>__cssModules
    <span class="token comment">// 如果不存在css模块，警告</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>modules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      __DEV__ <span class="token operator">&amp;&amp;</span> <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Current instance does not have CSS modules injected.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token constant">EMPTY_OBJ</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> mod <span class="token operator">=</span> modules<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
    <span class="token comment">// 如果不存在未找到name的css模块，警告</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mod<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      __DEV__ <span class="token operator">&amp;&amp;</span>
        <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Current instance does not have CSS module named &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token constant">EMPTY_OBJ</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> mod <span class="token keyword">as</span> Record<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> string<span class="token operator">&gt;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">useCssModule() is not supported in the global build.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token constant">EMPTY_OBJ</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><b>13、version</b></p> <ul><li>官方定义：以字符串形式提供已安装的 Vue 的版本号。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// vue-next/packages/vue/package.json 中的version 为3.1.2，使用.split('.')[0]，得出3</span>
<span class="token keyword">const</span> version <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>Vue<span class="token punctuation">.</span>version<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>version <span class="token operator">===</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Vue 3</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>version <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Vue 2</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// 不支持的 Vue 的版本</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">11/19/2021, 4:06:14 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/vue3/optimize.html" class="prev">
        代码优化/核心特性
      </a></span> <span class="next"><a href="/" class="router-link-active">
        Home
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.3affcc69.js" defer></script><script src="/assets/js/2.672bef9f.js" defer></script><script src="/assets/js/33.4b24bea9.js" defer></script>
  </body>
</html>
